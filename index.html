<!DOCTYPE html>
<html>
<head>
	<title>Catalyst! Energy Island</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />


	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="leaflet-0.7.2/leaflet.js"></script>
	<script src="http://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>	


	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="leaflet-0.7.2/leaflet.css" />
	<style>
		html, body, #map {
			height:100%;
			width:100%;
			padding:0px;
			margin:0px;
		} 
		#overlay {
			padding: 10px;
			bottom: 50px;
			height: 75px;
			position: absolute;
			right: 50px;
			width: 550px;
			opacity:0.9;
			filter:alpha(opacity=90); /* For IE8 and earlier */
			background-color: white;
		}
	</style>
	

</head>
<body>
	<div id="map" ></div>

	<div id="overlay">
	
		<h2>Find Tilley and Enter your Energy Observation!</h2>
		Click the map where you think Tilley is located.
		<br />Once you have found Tilley, enter your observation and click "Submit"
	
	</div>
	
	
	<script>
		//iframe popup content
		var popupformcontent = '<iframe src="form.html" width=400px height=400px  frameBorder="0" ></iframe>';

		//add map, set to tiree view
		var map = L.map('map').setView([56.5007, -6.8805], 13);  
		//add our custom map tiles
		L.tileLayer('http://{s}.tile.cloudmade.com/1D162E9F2DCA42C187DB33208932BFB6/997/256/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>, Energy Island by <a href="http://www.catalystproject.org.uk">Catalyst!</a>'
		}).addTo(map);




		/*L.circle([51.508, -0.11], 500, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map).bindPopup("I am a circle.");

		L.polygon([
			[51.509, -0.08],
			[51.503, -0.06],
			[51.51, -0.047]
		]).addTo(map).bindPopup("I am a polygon.");
*/

		var popup = L.popup();

		//map click callback fn
		function onMapClick(e) {
			
			
			//JSON list of POI, could be DB driven
			var pointsOfInterest = {"locations": [
				        {"name": "Tilley", "icon": {
															iconUrl: 'img/tilleyicon.png',
															shadowUrl: 'img/tilleyshadow.png',
															iconSize:     [58, 93], // size of the icon
															shadowSize:   [70, 38], // size of the shadow
															iconAnchor:   [36, 92], // point of the icon which will correspond to marker's location
															shadowAnchor: [53, 37],  // the same for the shadow
															popupAnchor:  [0, -55] // point from which the popup should open relative to the iconAnchor
														}, 
														"lat": 56.535727438167584, 
														"lon": -6.756131332397456},


				        {"name": "The Maze", "icon": {
															iconUrl: 'img/dune.png',
															//shadowUrl: 'img/tilleyshadow.png',
															iconSize:     [79, 36], // size of the icon
															//shadowSize:   [70, 38], // size of the shadow
															iconAnchor:   [40, 18], // point of the icon which will correspond to marker's location
															//shadowAnchor: [53, 37],  // the same for the shadow
															popupAnchor:  [0, -18] // point from which the popup should open relative to the iconAnchor
														},
														"lat": 56.493075, 
														"lon": -6.978421},

				        {"name": "Balevullin Beach", "icon": {
															iconUrl: 'img/wave.png',
															//shadowUrl: 'img/tilleyshadow.png',
															iconSize:     [53, 40], // size of the icon
															//shadowSize:   [70, 38], // size of the shadow
															iconAnchor:   [26, 20], // point of the icon which will correspond to marker's location
															//shadowAnchor: [53, 37],  // the same for the shadow
															popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
														},
														"lat": 56.52279, 
														"lon": -6.952651},

				        {"name": "Hynish Centre", "icon": {
															iconUrl: 'img/hynish.png',
															shadowUrl: 'img/hynishshadow.png',
															iconSize:     [22, 41], // size of the icon
															shadowSize:   [39, 20], // size of the shadow
															iconAnchor:   [11, 40], // point of the icon which will correspond to marker's location
															shadowAnchor: [30, 19],  // the same for the shadow
															popupAnchor:  [0, -38] // point from which the popup should open relative to the iconAnchor
														},
														"lat": 56.449000, 
														"lon": -6.893481
													}
				    ]
				};
			//track if we've clicked in the right place
			var foundALocation = false;
			
			//step through POI and check if the click is within a boundry of the location	
			pointsOfInterest.locations.forEach(function(loca) {

			    
				if ((e.latlng.lat >= (loca.lat-0.004) && e.latlng.lat <= (loca.lat+0.004)) && (e.latlng.lng >= (loca.lon-0.004) && e.latlng.lng <= (loca.lon+0.004))) {
					//add the marker
					L.marker([e.latlng.lat, e.latlng.lng],{icon: L.icon(loca.icon)}).addTo(map).bindPopup(popupformcontent,{'maxWidth':900}).openPopup();
					foundALocation = true;
				}
  
			});	
			//if we are outside the boundry tell the user
			if (!foundALocation) { popup.setLatLng(e.latlng).setContent("<b>Nothing here!</b><br/> Try again!").openOn(map); }


		}
		//add click listener to map with callback fn
		map.on('click', onMapClick);




		window.onload = function() { init() };

		function init() {

		      $.ajax({    //create an ajax request to grab data
		        type: "GET",
		        url: "http://cs-vyv.lancs.ac.uk/catalyst/energyisland/heatmapdata.php",             
		        dataType: "json",   //expect html to be returned                
		        success: function(response){                    
		            createMarkers(response); 
		            //alert(response);
		        }

		    });
		}


		function createMarkers(data){
			var markers = L.markerClusterGroup();
			//console.log(data);
			for (var i = 0; i < data.length; i++) {
				//console.log(data[i].timestamp);
				var title = data[i].readingdate;
				var marker = L.marker(new L.LatLng(data[i].lat, data[i].lng), { title: title });
				
				marker.bindPopup('<div class="marker-title"><b>Observed: ' +  data[i].readingdate.substring(1) + ' '+data[i].time+'</b></div>' + '<div class="marker-description-top">Wind: ' +  data[i].wind + ' <br> Solar: ' +  data[i].solar + ' <br> Comment: ' +  data[i].comment + '<br/><img width="250" src="'+data[i].image+'"></div>');
				markers.addLayer(marker);
				
				
			}
			map.addLayer(markers);
		}


	</script>
</body>
</html>
